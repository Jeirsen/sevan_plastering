<div class="row page-titles">
	<div class="col-md-5 col-8 align-self-center">
		<h3 class="text-themecolor">Sevan</h3>
		<ol class="breadcrumb">
	  	<li class="breadcrumb-item"><a href="<%= builder_path(@model.builder.id) %>">Models</a></li>
	    <li class="breadcrumb-item active"><%= @model.name %></li>
	  </ol>
	</div>
</div>

<div class="row">
	<div class="col-md-12 col-sm-12">
		<h2 class="text-info"><%= @model.name %> <button class="btn btn-primary" onclick="editModel(<%= @model.id %>)">Edit</button></h2>
	</div>
	<div class="col-md-12 col-sm-12">
		<label class="font-weight-bold">Builder: </label> <%= @model.builder.name %>
	</div>
	<div class="col-md-12 col-sm-12">
		<label class="font-weight-bold">Model Image</label>
    <br>
		<img src="<%= @model.model_image %>" >
	</div>
</div>

<br>
<div class="row" id="model_template">
  <div class="col-md-12 col-sm-12" style="display: -webkit-inline-box;">
    <h2 class="text-info">Template</h2>&nbsp;&nbsp;&nbsp;
    <button type="button" class="btn btn-outline-info" data-toggle="modal" data-target="#addProduct">
      <i class="fa fa-plus"></i> Add Product
    </button>
  </div>
  <% if !@model.templates.blank? %>
  	<% @model.templates.each do |template| %>
  		<div class="col-lg-3 col-md-6">
		    <a onclick="openModalEditTemplate(this)" class="edit-template" style="cursor: pointer;">
		      <div class="card" data-id="<%= template.id %>" data-quantity="<%= template.quantity %>" data-product-id="<%= template.product_id %>">
		        <div class="d-flex flex-row">
		          <div class="p-20">
		            <h5 class="m-b-0 text-info">
		              <small class="quantity">Q<%= template.quantity %> <%= template.product.unit.name %></small>
		            </h5>
		          </div>
		          <div class="align-self-center m-l-20">
		            <small class="text-muted m-b-0"><%= template.product.name %></small>
		          </div>
		        </div>
		      </div>
		    </a>
	    </div>
    <% end %>
  <% else %>
    <div class="col-md-12 col-sm-12">
      <div class="alert alert-info" style="width: 100%">
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">×</span>
        </button>
        <h3 class="text-info">
          <i class="fa fa-exclamation-circle"></i> Information
        </h3> 
        This model has an empty template, please go and add some products.
      </div>
    </div>
  <% end %>
</div>

<!-- modals -->
<div class="modal fade" id="addProduct" role="dialog" aria-labelledby="addProduct">
  <div class="modal-dialog" role="document">
      <div class="modal-content">
          <div class="modal-header">
              <h4 class="modal-title">Add Template Product</h4>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          </div>
          <div class="modal-body">
            <form>
              <div class="form-group">
                  <label for="recipient-name" class="control-label">Product:</label>
                  <select id="add-product"></select>
                  <span class="label label-danger" style="display: none" id="danger_product">Product is required!</span>
              </div>
              <div class="form-group">
                  <label for="recipient-name" class="control-label">Quantity:</label>
                  <input type="number" class="form-control" id="template_quantity" required>
                  <span class="label label-danger" style="display: none" id="danger_quantity">Quantity is required!</span>
              </div>
              <div class="alert" id="template_alert" style="display: none">
              </div>
            </form>
          </div>
          <div class="modal-footer">
              <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
              <button onclick="addTemplateProduct()" ontype="button" class="btn btn-primary waves-effect waves-light">Add</button>
          </div>
      </div>
  </div>
</div>

<div class="modal fade" id="editProduct" role="dialog" aria-labelledby="editProduct">
  <div class="modal-dialog" role="document">
      <div class="modal-content">
          <div class="modal-header">
              <h4 class="modal-title">Edit Template Product</h4>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          </div>
          <div class="modal-body">
            <form>
              <div class="form-group">
                  <label for="recipient-name" class="control-label">Product:</label>
                  <input type="text" class="form-control" id="edit_product" readonly="true">
                  <span class="label label-danger" style="display: none" id="danger_edit_product">Product is required!</span>
              </div>
              <div class="form-group">
                  <label for="recipient-name" class="control-label">Quantity:</label>
                  <input type="text" class="form-control" id="edit_product_quantity" required>
                  <span class="label label-danger" style="display: none" id="danger_edit_quantity">Quantity is required!</span>
              </div>
              <div class="alert" id="edit_product_alert" style="display: none">
              </div>
            </form>
            
          </div>
          <div class="modal-footer">
              <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
              <button onclick="editTemplateProduct()" ontype="button" class="btn btn-primary waves-effect waves-light">Edit</button>
          </div>
      </div>
  </div>
</div>

<div class="modal fade" id="content_modal_model" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content modal-inject-model">
    </div>
  </div>
</div>

<script type="text/javascript">

  //edit  MODEL

  function editModel(id){
      $.get("/model/"+id+"/edit",function(data){
          $(".modal-inject-model").html(data);
          $("#content_modal_model").modal('show');
      })
  }

	//For Template Products
	var idProductTemplateForEditing = 0;
	var product_id = 0;
	var templateElement = "";

	$(document).ready(function(){
		$("#add-product").select2({
	    theme: "bootstrap",
	    ajax:{
	      url: "<%= search_products_path %>",
	      dataType: 'json',
	      data: function(params){
	        return{
	          q: params.term
	        };
	      },
	      processResults: function (data) {
	        return {
	            results: data.data
	        };
	      },
	    },
	    minimumInputLength: 3,
	    placeholder: {
	      id: '-1',
	      text: 'Enter product name ...'
	    },
	    escapeMarkup: function (markup) {
	      return markup;
	    },
	    templateResult: function (product) {
	      if (product.loading) return 'product.name';
	      return $("<div>"+ product.name +"</div>")
	    }, 
	    templateSelection: function (product) {
	      if (product === '' || product === null){
	          return '<span>Enter product name ...</span>';
	      }
	      return $("<span>"+ product.name +"</span>")
	    }
	  });
	});

	function addTemplateProduct(){
		if (!validateTemplateData()){
	    product_id = $('#add-product :selected').val();
	    quantity = parseInt($("#template_quantity").val());
	    model_id = <%= @model.id %>

	    template_object = {
	      template : {
	        id: 0,
	        model_id: model_id,
	        product_id: product_id,
	        quantity: quantity
	      }
	    }

	    $.ajax({
	      url: "<%= template_product_path %>",
	      method: "POST",
	      data: template_object,
	      success: function (data) {
	        if(data.success){
	          appendTemplateProduct(data.id, product_id, data.unit_name);
	          $("#template_alert").empty();
	          $("#template_alert").removeClass("alert-danger");
	          $("#template_alert").addClass("alert-success");
	          message = data.data + '<button type="button" class="close" data-dismiss="alert" aria-label="Close">\
	                    <span aria-hidden="true">×</span>\
	                    </button>';
	          $("#template_alert").append(message);
	          $("#template_alert").show();
	          setTimeout(function(){
	            $("#template_alert").hide();
	            $("#addProduct").modal('hide');
	          },5000);
	        }else{
	          $("#template_alert").empty();
	          $("#template_alert").removeClass("alert-success");
	          $("#template_alert").addClass("alert-danger");
	          message = data.data + '<button type="button" class="close" data-dismiss="alert" aria-label="Close">\
	                    <span aria-hidden="true">×</span>\
	                    </button>';
	          $("#template_alert").append(message);
	          $("#template_alert").show();
	          setTimeout(function(){
	            $("#template_alert").hide();
	          },5000);
	        }
	      },
	      error: function (data) {
	        $("#template_alert").empty();
	        $("#template_alert").removeClass("alert-success");
	        $("#template_alert").addClass("alert-danger");
	        message = data.data + '<button type="button" class="close" data-dismiss="alert" aria-label="Close">\
	                  <span aria-hidden="true">×</span>\
	                  </button>';
	        $("#template_alert").append(message);
	        $("#template_alert").show();
	        setTimeout(function(){
	          $("#template_alert").hide();
	        },5000);
	      }
	    })
	  }
	}

	function validateTemplateData(){
	  product_id = $('#add-product :selected').val();
	  quantity = parseInt($("#template_quantity").val());
	  error = false;

	  if(product_id === undefined || product_id === null || product_id === 0)
	  { 
	    $("#danger_product").show();
	    setTimeout(function(){
	        $('#danger_product').hide();
	    },5000);
	    error = true;
	  }

	  if(quantity === "" || quantity === 0)
	  { 
	    $("#danger_quantity").show();
	    setTimeout(function(){
	        $('#danger_quantity').hide();
	    },5000);
	    error = true;
	  }

	  return error;
	}

	function appendTemplateProduct(record_id, product_id, unit_name){
		quantity = $("#template_quantity").val();
	  product_name = $('#add-product').select2('data')[0].name;

	  var element = '<div class="col-lg-3 col-md-6">\
	    							<a onclick="openModalEditTemplate(this)" class="edit-template" style="cursor: pointer;">\
	      							<div class="card" data-id="'+record_id+'" data-quantity="'+quantity+'" data-product-id="'+product_id+'">\
	        							<div class="d-flex flex-row">\
	          							<div class="p-20">\
	            							<h5 class="m-b-0 text-info">\
	              							<small class="quantity">Q'+quantity +' '+ unit_name +'</small>\
	            							</h5>\
	          							</div>\
	          							<div class="align-self-center m-l-20">\
	            							<small class="text-muted m-b-0">'+product_name+'</small>\
	          							</div>\
	        							</div>\
	      							</div>\
	    							</a>\
  								</div>';

	  $("#model_template").append(element);
	  $("#template_quantity").val("");
	}

	function openModalEditTemplate(element){
		idProductTemplateForEditing = $(element).find(".card").attr("data-id");
		product_id = $(element).find(".card").attr("data-product-id");
		quantity = parseInt($(element).find(".card").attr("data-quantity"));
		templateElement = element;
		product_name = $(element).find("small");
	
	  $('#edit_product').val(product_name[1].innerText);
	  $('#edit_product_quantity').val(quantity);
	  $('#editProduct').modal('show');
	}

	function editTemplateProduct(){
	  quantity = parseInt($("#edit_product_quantity").val());
	  model_id = <%= @model.id %>

	  if (!isNaN(quantity) || quantity !== null){
	    template_object = {
	      template : {
	        id: idProductTemplateForEditing,
	        model_id: model_id,
	        product_id: product_id,
	        quantity: quantity
	      }
	    }

	    $.ajax({
	      url: "<%= template_product_path %>",
	      method: "POST",
	      data: template_object,
	      success: function (data) {
	        if(data.success){
	          updateProductElement(data.unit_name);
	          $("#edit_product_alert").empty();
	          $("#edit_product_alert").removeClass("alert-danger");
	          $("#edit_product_alert").addClass("alert-success");
	          message = data.data + '<button type="button" class="close" data-dismiss="alert" aria-label="Close">\
	                    <span aria-hidden="true">×</span>\
	                    </button>';
	          $("#edit_product_alert").append(message);
	          $("#edit_product_alert").show();
	          setTimeout(function(){
	            $("#edit_product_alert").hide();
	            $("#editProduct").modal('hide');
	          },5000);
	        }else{
	          $("#edit_product_alert").empty();
	          $("#edit_product_alert").removeClass("alert-success");
	          $("#edit_product_alert").addClass("alert-danger");
	          message = data.data + '<button type="button" class="close" data-dismiss="alert" aria-label="Close">\
	                    <span aria-hidden="true">×</span>\
	                    </button>';
	          $("#edit_product_alert").append(message);
	          $("#edit_product_alert").show();
	          setTimeout(function(){
	            $("#edit_product_alert").hide();
	          },5000);
	        }
	      },
	      error: function (data) {
	        $("#edit_product_alert").empty();
	        $("#edit_product_alert").removeClass("alert-success");
	        $("#edit_product_alert").addClass("alert-danger");
	        message = data.data + '<button type="button" class="close" data-dismiss="alert" aria-label="Close">\
	                  <span aria-hidden="true">×</span>\
	                  </button>';
	        $("#edit_product_alert").append(message);
	        $("#edit_product_alert").show();
	        setTimeout(function(){
	          $("#edit_product_alert").hide();
	        },5000);
	      }
	    })

	  }else{
	    $("#danger_edit_quantity").show();
	    setTimeout(function(){
	        $('#danger_edit_quantity').hide();
	    },5000);
	  }
	}

	function updateProductElement(unit_name){
	  quantity = parseInt($("#edit_product_quantity").val());
	  $(templateElement).find(".quantity").text("Q" + quantity + " " + unit_name);
	  $(templateElement).find(".card").attr('data-quantity', quantity); 
	  templateElement = "";
	  idProductTemplateForEditing = 0;
	}

</script>